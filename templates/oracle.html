<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oracle - Multi-Agent System Monitor</title>
    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-card: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --text-muted: #8b949e;
            --primary: #58a6ff;
            --success: #3fb950;
            --warning: #d29922;
            --danger: #f85149;
            --purple: #a371f7;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1a1f35 0%, #0d1117 100%);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(90deg, var(--primary), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-status {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-online { background: rgba(63, 185, 80, 0.2); color: var(--success); }
        .status-offline { background: rgba(248, 81, 73, 0.2); color: var(--danger); }

        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 1rem;
            padding: 1rem;
            height: calc(100vh - 60px);
        }

        /* Agent Panel */
        .agent-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }
        .agent-list {
            padding: 0.5rem;
        }
        .agent-card {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .agent-card:hover { border-color: var(--primary); }
        .agent-card.selected { border-color: var(--primary); background: rgba(88, 166, 255, 0.1); }
        .agent-card.active { border-left: 3px solid var(--success); }
        .agent-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .agent-model {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        .agent-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }
        .agent-status.idle { background: var(--text-muted); }
        .agent-status.thinking { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Chat Area */
        .chat-area {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
            max-width: 90%;
        }
        .message.user {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid var(--primary);
            margin-left: auto;
        }
        .message.agent {
            background: var(--bg-dark);
            border: 1px solid var(--border);
        }
        .message.system {
            background: rgba(163, 113, 247, 0.1);
            border: 1px solid var(--purple);
            text-align: center;
            max-width: 100%;
            font-size: 0.85rem;
        }
        .message-header {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        .message-content {
            white-space: pre-wrap;
            word-break: break-word;
        }
        .message-content code {
            background: var(--bg-dark);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
        }
        .thinking-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--warning);
            font-style: italic;
        }
        .thinking-dots span {
            animation: blink 1.4s infinite both;
        }
        .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
        }
        .chat-input-area input {
            flex: 1;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            color: var(--text);
            font-size: 0.9rem;
        }
        .chat-input-area input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .chat-input-area button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover { opacity: 0.9; }
        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Info Panel */
        .info-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .info-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }
        .info-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-muted);
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .info-tab:hover { color: var(--text); }
        .info-tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }
        .info-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .info-section {
            margin-bottom: 1rem;
        }
        .info-section h4 {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }
        .stat-value {
            font-weight: 600;
            color: var(--primary);
        }
        .oracle-log {
            background: var(--bg-dark);
            border-radius: 4px;
            padding: 0.75rem;
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* Quick Actions */
        .quick-actions {
            padding: 1rem;
            border-top: 1px solid var(--border);
        }
        .quick-actions h4 {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        .action-btn {
            padding: 0.5rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        .action-btn:hover {
            border-color: var(--primary);
            background: rgba(88, 166, 255, 0.1);
        }

        /* Agent selector dropdown */
        .agent-selector {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.5rem;
            color: var(--text);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>Oracle - Multi-Agent System</h1>
        <div class="header-status">
            <span id="ollama-status" class="status-badge status-offline">Ollama: Checking...</span>
            <span id="agents-count" class="status-badge status-online">Agents: 3</span>
            <a href="/" style="color: var(--primary); text-decoration: none;">Back to Dashboard</a>
        </div>
    </header>

    <div class="main-container">
        <!-- Agent Panel -->
        <div class="agent-panel">
            <div class="panel-header">Agents</div>
            <div class="agent-list" id="agent-list">
                <div class="agent-card selected" data-agent="a-solver">
                    <div class="agent-name">
                        <span class="agent-status"></span>
                        A-Solver
                    </div>
                    <div class="agent-model">qwen3-vl:8b (6.1GB)</div>
                    <div class="agent-model">Fast, Wallet Forensics</div>
                </div>
                <div class="agent-card" data-agent="b-solver">
                    <div class="agent-name">
                        <span class="agent-status idle"></span>
                        B-Solver
                    </div>
                    <div class="agent-model">phi4-reasoning:14b (11GB)</div>
                    <div class="agent-model">Deep Reasoning, Anomalies</div>
                </div>
                <div class="agent-card" data-agent="c-solver">
                    <div class="agent-name">
                        <span class="agent-status idle"></span>
                        C-Solver
                    </div>
                    <div class="agent-model">qwq:32b (19GB)</div>
                    <div class="agent-model">Prediction, Synthesis</div>
                </div>
                <div class="agent-card" data-agent="maestro">
                    <div class="agent-name">
                        <span class="agent-status"></span>
                        Maestro
                    </div>
                    <div class="agent-model">Claude (Opus)</div>
                    <div class="agent-model">Orchestration</div>
                </div>
            </div>

            <div class="quick-actions">
                <h4>Quick Actions</h4>
                <div class="action-grid">
                    <button class="action-btn" onclick="runOracleQuery('a-solver')">A: Analyze</button>
                    <button class="action-btn" onclick="runOracleQuery('b-solver')">B: Reason</button>
                    <button class="action-btn" onclick="runOracleQuery('c-solver')">C: Predict</button>
                    <button class="action-btn" onclick="refreshAgentStatus()">Refresh All</button>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <div>
                    <strong>Oracle Chat</strong>
                    <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 0.5rem;">
                        Deep reasoning with streaming output
                    </span>
                </div>
                <select id="target-agent" class="agent-selector">
                    <option value="auto">Auto (Maestro decides)</option>
                    <option value="a-solver">A-Solver (Fast)</option>
                    <option value="b-solver">B-Solver (Deep)</option>
                    <option value="c-solver">C-Solver (Predict)</option>
                </select>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="message system">
                    <div class="message-content">
                        Oracle Mode Active - Reasoning models stream output in real-time.
                        No timeout limits. Let them think deeply.
                    </div>
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="oracle-input" placeholder="Ask about Bitcoin puzzle patterns, predictions, or analysis..." />
                <button class="btn-primary" onclick="sendOracleMessage()">Send</button>
                <button class="btn-danger" id="stop-btn" onclick="stopOracle()" style="display: none;">Stop</button>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="info-panel">
            <div class="info-tabs">
                <button class="info-tab active" data-tab="status">Status</button>
                <button class="info-tab" data-tab="memory">Memory</button>
                <button class="info-tab" data-tab="output">Live Output</button>
                <button class="info-tab" data-tab="results">Results</button>
            </div>
            <div class="info-content" id="info-content">
                <div id="tab-status" class="tab-panel">
                    <div class="info-section">
                        <h4>System Status</h4>
                        <div class="stat-row">
                            <span>Ollama</span>
                            <span class="stat-value" id="ollama-models">-</span>
                        </div>
                        <div class="stat-row">
                            <span>GPU Memory</span>
                            <span class="stat-value" id="gpu-memory">-</span>
                        </div>
                        <div class="stat-row">
                            <span>Active Tasks</span>
                            <span class="stat-value" id="active-tasks">0</span>
                        </div>
                    </div>
                    <div class="info-section">
                        <h4>Target Puzzle</h4>
                        <div class="stat-row">
                            <span>Current</span>
                            <span class="stat-value" id="target-puzzle">71</span>
                        </div>
                        <div class="stat-row">
                            <span>Solved</span>
                            <span class="stat-value">70</span>
                        </div>
                        <div class="stat-row">
                            <span>k69 Position</span>
                            <span class="stat-value">0.72%</span>
                        </div>
                    </div>
                    <div class="info-section">
                        <h4>Key Insights</h4>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">
                            <p>- k69 at 0.72% (solved fast)</p>
                            <p>- k5=k2xk3, k6=k3^2</p>
                            <p>- Search first 1% of range</p>
                        </div>
                    </div>
                </div>
                <div id="tab-memory" class="tab-panel" style="display: none;">
                    <div class="info-section">
                        <h4>Agent Memory Stats</h4>
                        <div class="stat-row">
                            <span>Total Conversations</span>
                            <span class="stat-value" id="mem-conversations">0</span>
                        </div>
                        <div class="stat-row">
                            <span>Oracle Queries</span>
                            <span class="stat-value" id="mem-oracle-queries">0</span>
                        </div>
                        <div class="stat-row">
                            <span>Total Insights</span>
                            <span class="stat-value" id="mem-insights">0</span>
                        </div>
                        <div class="stat-row">
                            <span>Verified Insights</span>
                            <span class="stat-value" id="mem-verified">0</span>
                        </div>
                        <div class="stat-row">
                            <span>Shared Knowledge</span>
                            <span class="stat-value" id="mem-shared">0</span>
                        </div>
                    </div>
                    <div class="info-section">
                        <h4>Per-Agent Activity</h4>
                        <div id="agent-memory-list" style="font-size: 0.8rem;">
                            Loading...
                        </div>
                    </div>
                    <div class="info-section">
                        <button class="action-btn" onclick="refreshMemoryStats()" style="width: 100%;">Refresh Memory</button>
                    </div>
                </div>
                <div id="tab-output" class="tab-panel" style="display: none;">
                    <h4>Live Streaming Output</h4>
                    <div class="oracle-log" id="oracle-log">
                        Waiting for oracle query...
                    </div>
                </div>
                <div id="tab-results" class="tab-panel" style="display: none;">
                    <h4>Analysis Results</h4>
                    <div id="results-content" style="font-size: 0.85rem;">
                        No results yet. Run an oracle query to see analysis.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAgent = 'a-solver';
        let isStreaming = false;
        let eventSource = null;

        // Tab switching
        document.querySelectorAll('.info-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.info-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).style.display = 'block';
            });
        });

        // Agent selection
        document.querySelectorAll('.agent-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                currentAgent = card.dataset.agent;
                document.getElementById('target-agent').value = currentAgent;
            });
        });

        // Send message
        function sendOracleMessage() {
            const input = document.getElementById('oracle-input');
            const message = input.value.trim();
            if (!message) return;

            const targetAgent = document.getElementById('target-agent').value;
            addMessage('user', message);
            input.value = '';

            // Show thinking indicator
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message agent';
            thinkingDiv.id = 'thinking-msg';
            thinkingDiv.innerHTML = `
                <div class="message-header">${getAgentName(targetAgent)} is thinking...</div>
                <div class="thinking-indicator">
                    <span class="thinking-dots"><span>.</span><span>.</span><span>.</span></span>
                    Deep reasoning in progress
                </div>
            `;
            document.getElementById('chat-messages').appendChild(thinkingDiv);
            scrollChat();

            // Start streaming
            startOracleStream(message, targetAgent);
        }

        function startOracleStream(message, agent) {
            isStreaming = true;
            document.getElementById('stop-btn').style.display = 'inline-block';

            // Switch to output tab
            document.querySelectorAll('.info-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
            document.querySelector('[data-tab="output"]').classList.add('active');
            document.getElementById('tab-output').style.display = 'block';

            const logDiv = document.getElementById('oracle-log');
            logDiv.textContent = '';

            // Use EventSource for streaming
            const url = `/api/oracle/stream?agent=${agent}&message=${encodeURIComponent(message)}`;
            eventSource = new EventSource(url);

            let fullResponse = '';

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.token) {
                    fullResponse += data.token;
                    logDiv.textContent = fullResponse;
                    logDiv.scrollTop = logDiv.scrollHeight;
                }
                if (data.done) {
                    finishStream(fullResponse, agent);
                }
            };

            eventSource.onerror = (error) => {
                // Fallback to POST request if SSE fails
                eventSource.close();
                fetchOracleResponse(message, agent);
            };
        }

        function fetchOracleResponse(message, agent) {
            fetch('/api/oracle/query', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message, agent})
            })
            .then(r => r.json())
            .then(data => {
                const logDiv = document.getElementById('oracle-log');
                logDiv.textContent = data.response || 'No response';
                finishStream(data.response || '', agent);
            })
            .catch(err => {
                console.error('Oracle error:', err);
                finishStream('Error: ' + err.message, agent);
            });
        }

        function finishStream(response, agent) {
            isStreaming = false;
            document.getElementById('stop-btn').style.display = 'none';

            // Remove thinking indicator
            const thinking = document.getElementById('thinking-msg');
            if (thinking) thinking.remove();

            // Add response message
            addMessage('agent', response, agent);

            // Close event source
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        function stopOracle() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            isStreaming = false;
            document.getElementById('stop-btn').style.display = 'none';

            const thinking = document.getElementById('thinking-msg');
            if (thinking) {
                thinking.innerHTML = `
                    <div class="message-header">Query stopped</div>
                    <div class="message-content" style="color: var(--warning);">[Stopped by user]</div>
                `;
            }
        }

        function addMessage(type, content, agent = null) {
            const messagesDiv = document.getElementById('chat-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${type}`;

            const header = type === 'user' ? 'You' : getAgentName(agent || currentAgent);
            msgDiv.innerHTML = `
                <div class="message-header">${header}</div>
                <div class="message-content">${escapeHtml(content)}</div>
            `;
            messagesDiv.appendChild(msgDiv);
            scrollChat();
        }

        function getAgentName(agent) {
            const names = {
                'a-solver': 'A-Solver (qwen3-vl:8b)',
                'b-solver': 'B-Solver (phi4-reasoning)',
                'c-solver': 'C-Solver (qwq:32b)',
                'maestro': 'Maestro (Claude)',
                'auto': 'Auto'
            };
            return names[agent] || agent;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollChat() {
            const messages = document.getElementById('chat-messages');
            messages.scrollTop = messages.scrollHeight;
        }

        function runOracleQuery(agent) {
            document.getElementById('target-agent').value = agent;
            const prompts = {
                'a-solver': 'Analyze the byte patterns in keys k1-k10 and identify the derivation method',
                'b-solver': 'Using deep reasoning, analyze why k69 was at 0.72% position and predict k71 position',
                'c-solver': 'Synthesize all anomalies and predict the optimal search region for k71'
            };
            document.getElementById('oracle-input').value = prompts[agent] || '';
            sendOracleMessage();
        }

        function refreshAgentStatus() {
            fetch('/api/oracle/status')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('ollama-status').textContent =
                        `Ollama: ${data.ollama_connected ? 'Connected' : 'Offline'}`;
                    document.getElementById('ollama-status').className =
                        `status-badge ${data.ollama_connected ? 'status-online' : 'status-offline'}`;
                    document.getElementById('ollama-models').textContent =
                        data.model_count + ' models';
                    document.getElementById('gpu-memory').textContent =
                        data.gpu_memory || 'N/A';
                    document.getElementById('active-tasks').textContent =
                        data.active_tasks || '0';
                    document.getElementById('target-puzzle').textContent =
                        data.target_puzzle || '71';
                })
                .catch(err => {
                    console.error('Status error:', err);
                });
        }

        // Enter to send
        document.getElementById('oracle-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isStreaming) {
                sendOracleMessage();
            }
        });

        // Memory stats
        function refreshMemoryStats() {
            fetch('/api/oracle/memory/stats')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.stats;
                        document.getElementById('mem-conversations').textContent = stats.total_conversations || 0;
                        document.getElementById('mem-oracle-queries').textContent = stats.total_oracle_queries || 0;
                        document.getElementById('mem-insights').textContent = stats.total_insights || 0;
                        document.getElementById('mem-verified').textContent = stats.verified_insights || 0;
                        document.getElementById('mem-shared').textContent = stats.shared_knowledge_count || 0;

                        // Per-agent display
                        const agents = data.agents;
                        let agentHtml = '';
                        for (const [id, info] of Object.entries(agents)) {
                            const score = info.certification_score || 'N/A';
                            const status = info.certification_status || 'unknown';
                            const queries = info.total_queries || 0;
                            const insights = info.total_insights || 0;
                            agentHtml += `
                                <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: var(--bg-dark); border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <strong>${id.toUpperCase()}</strong>
                                        <span style="color: ${status === 'certified' ? 'var(--success)' : status === 'active' ? 'var(--primary)' : 'var(--warning)'}">${status}</span>
                                    </div>
                                    <div style="color: var(--text-muted); font-size: 0.75rem;">
                                        ${info.model || '-'} | Score: ${score} | Q: ${queries} | I: ${insights}
                                    </div>
                                </div>
                            `;
                        }
                        document.getElementById('agent-memory-list').innerHTML = agentHtml || 'No agents found';
                    }
                })
                .catch(err => {
                    console.error('Memory stats error:', err);
                });
        }

        // Save messages to memory when sending
        function saveToMemory(agentId, role, content) {
            fetch('/api/oracle/memory/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    agent_id: agentId,
                    role: role,
                    content: content.substring(0, 2000)  // Truncate for storage
                })
            }).catch(err => console.log('Memory save:', err));
        }

        // Initial load
        refreshAgentStatus();
        refreshMemoryStats();
        setInterval(refreshAgentStatus, 30000);
        setInterval(refreshMemoryStats, 60000);  // Refresh memory every minute
    </script>
</body>
</html>
